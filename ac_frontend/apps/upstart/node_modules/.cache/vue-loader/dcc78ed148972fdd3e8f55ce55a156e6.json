{"remainingRequest":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\src\\components\\CheckoutComfirm.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\src\\components\\CheckoutComfirm.vue","mtime":1604879633595},{"path":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Go\\src\\alphacare\\ac_frontend\\apps\\admin\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQoNCmltcG9ydCB7bG9hZFN0cmlwZX0gZnJvbSAnQHN0cmlwZS9zdHJpcGUtanMnOw0KaW1wb3J0IHtFdmVudEJ1cyBhcyBidXN9IGZyb20gIi4uL2V2ZW50X2J1cy5qcyINCmltcG9ydCBheGlvcyBmcm9tICJheGlvcyI7DQppbXBvcnQge2RlZmF1bHQgYXMgQVBJX0VORFBPSU5UU30gZnJvbSAiQC9hcGkiOw0KDQpleHBvcnQgZGVmYXVsdCB7DQogIGNvbXBvbmVudHM6IHt9LA0KICBwcm9wczogWydwbGFuJywgJ2FjY291bnRJbmZvJ10sDQogIGRhdGEoKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHN0cmlwZToge30sDQogICAgICBlbGVtZW50czoge30sDQogICAgICBjYXJkOiB7fSwNCiAgICAgIHN0cmlwZVB1YmxpY0tleTogcHJvY2Vzcy5lbnYuVlVFX0FQUF9TVFJJUEVfUFVCTElDX0tFWSwNCiAgICAgIHNuYWNrYmFyOiBmYWxzZSwNCiAgICAgIG1zZzogIiIsDQogICAgICBjb3Vwb246ICIiLA0KICAgICAgaXNDb3Vwb25WYWxpZDogZmFsc2UsDQogICAgICBzaG93blByaWNlOiAiIg0KICAgIH0NCiAgfSwNCiAgd2F0Y2g6IHsNCiAgICBjb3Vwb246IGZ1bmN0aW9uICgpIHsNCiAgICAgIHRoaXMuaXNDb3Vwb25WYWxpZCA9IGZhbHNlDQogICAgICB0aGlzLnNob3duUHJpY2UgPSB0aGlzLnBsYW4ucHJpY2UNCiAgICB9LA0KICAgIHBsYW46IGZ1bmN0aW9uKCkgew0KICAgICAgdGhpcy5zaG93blByaWNlID0gdGhpcy5wbGFuLnByaWNlDQogICAgICB0aGlzLmlzQ291cG9uVmFsaWQgPSBmYWxzZQ0KICAgICAgdGhpcy5jb3Vwb24gPSAiIg0KICAgIH0NCiAgfSwNCiAgY29tcHV0ZWQ6IHsNCiAgICBnZXRJY29uKCkgew0KICAgICAgaWYgKCF0aGlzLmNvdXBvbikgew0KICAgICAgICByZXR1cm4gIm1kaS10aWNrZXQtcGVyY2VudC1vdXRsaW5lIg0KICAgICAgfSBlbHNlIGlmICh0aGlzLmlzQ291cG9uVmFsaWQpIHsNCiAgICAgICAgcmV0dXJuICJtZGktY2hlY2siDQogICAgICB9DQogICAgICByZXR1cm4gIm1kaS1jbG9zZSINCiAgICB9DQogIH0sDQogIG1ldGhvZHM6IHsNCiAgICBjbGVhckNvdXBvbigpIHsNCiAgICAgIGlmICghdGhpcy5pc0NvdXBvblZhbGlkICYmIHRoaXMuY291cG9uKSB7DQogICAgICAgIHRoaXMuY291cG9uID0gIiINCiAgICAgICAgdGhpcy5pc0NvdXBvblZhbGlkID0gZmFsc2UNCiAgICAgICAgdGhpcy5zaG93blByaWNlID0gdGhpcy5wbGFuLnByaWNlDQogICAgICB9DQogICAgfSwNCiAgICBhcHBseUNvdXBvbigpIHsNCiAgICAgIHRoaXMucmVhZENvdXBvbigpDQogICAgICAgICAgLnRoZW4oKHJlc3ApID0+IHsNCiAgICAgICAgICAgIHRoaXMuaXNDb3Vwb25WYWxpZCA9IHRydWUNCiAgICAgICAgICAgIHRoaXMuc2hvd25QcmljZSA9IHJlc3AuZGF0YS5wZXJjZW50X29mZiAvIDEwMCAqIHRoaXMucGxhbi5wcmljZQ0KICAgICAgICAgIH0pDQogICAgICAgICAgLmNhdGNoKCgpID0+IHsNCiAgICAgICAgICAgIHRoaXMuaXNDb3Vwb25WYWxpZCA9IGZhbHNlDQogICAgICAgICAgICB0aGlzLmNvdXBvbiA9ICIiDQogICAgICAgICAgICB0aGlzLiRyZWZzLmNvdXBvblJlZi5mb2N1cygpDQogICAgICAgICAgICB0aGlzLnNob3dFcnJvck1lc3NhZ2UoIkNvdXBvbiBpcyBub3QgdmFsaWQiKQ0KICAgICAgICAgIH0pDQogICAgfSwNCiAgICByZWFkQ291cG9uKCkgew0KICAgICAgcmV0dXJuIGF4aW9zKHsNCiAgICAgICAgdXJsOiBBUElfRU5EUE9JTlRTLlJFQURfQ09VUE9OKHRoaXMuY291cG9uKSwNCiAgICAgICAgbWV0aG9kOiAnR0VUJw0KICAgICAgfSkNCiAgICB9LA0KICAgIHVwZGF0ZVN1YnNjcmlwdGlvbigpIHsNCiAgICAgIGNvbnN0IGRhdGEgPSB7DQogICAgICAgIHByaWNlSWQ6IHRoaXMucGxhbi5wcmljZUlkLA0KICAgICAgfQ0KICAgICAgcmV0dXJuIGF4aW9zKHsNCiAgICAgICAgdXJsOiBBUElfRU5EUE9JTlRTLlVQREFURV9TVUJTQ1JJUFRJT04odGhpcy5hY2NvdW50SW5mby5lbWFpbCwgdGhpcy5hY2NvdW50SW5mby5zdWJzY3JpcHRpb25JZCksDQogICAgICAgIGRhdGE6IGRhdGEsDQogICAgICAgIG1ldGhvZDogJ1BVVCcNCiAgICAgIH0pDQogICAgfSwNCiAgICBjcmVhdGVTZXNzaW9uKCkgew0KICAgICAgY29uc3QgZGF0YSA9IHsNCiAgICAgICAgY291cG9uOiB0aGlzLmNvdXBvbiwNCiAgICAgICAgcHJpY2VJZDogdGhpcy5wbGFuLnByaWNlSWQsDQogICAgICAgIHN0cmlwZUN1c3RvbWVySWQ6IHRoaXMuYWNjb3VudEluZm8uc3RyaXBlQ3VzdG9tZXJJZCwNCiAgICAgICAgcGxhbjogdGhpcy5wbGFuLm5hbWUsDQogICAgICAgIHN1Y2Nlc3NVcmw6IHByb2Nlc3MuZW52LlZVRV9BUFBfV0VCX0hPU1QgKyIvcGxhbj9zdGF0dXM9b2siLA0KICAgICAgICBjYW5jZWxVcmw6IHByb2Nlc3MuZW52LlZVRV9BUFBfV0VCX0hPU1QgKyAiL3BsYW4/c3RhdHVzPWZhaWxlZCIsDQogICAgICAgIGVtYWlsOiB0aGlzLiRzdG9yZS5nZXR0ZXJzLmVtYWlsID8gdGhpcy4kc3RvcmUuZ2V0dGVycy5lbWFpbCA6IHRoaXMuYWNjb3VudEluZm8uZW1haWwNCiAgICAgIH0NCiAgICAgIHJldHVybiBheGlvcyh7dXJsOiBBUElfRU5EUE9JTlRTLkNIRUNLT1VUX0NSRUFURV9TRVNTSU9OLCBkYXRhOiBkYXRhLCBtZXRob2Q6ICdQT1NUJyB9KQ0KICAgIH0sDQogICAgY2hlY2tvdXQoKSB7DQogICAgICBpZiAodGhpcy5hY2NvdW50SW5mbz8uc3Vic2NyaXB0aW9uUHJpY2VJZCA9PSAiIikgew0KICAgICAgICAvLyBpZiB0aGUgdXNlciBoYXMgbm8gc3Vic2NyaXB0aW9uUHJpY2VJZCwgaXQgaXMgYSBicmFuZCBuZXcgc3Vic2NyaXB0aW9uLg0KICAgICAgICB0aGlzLmNyZWF0ZVNlc3Npb24oKS4NCiAgICAgICAgdGhlbigocmVzcCkgPT4gew0KICAgICAgICAgIHRoaXMuc3RyaXBlLnJlZGlyZWN0VG9DaGVja291dCh7IHNlc3Npb25JZDogcmVzcC5kYXRhLmlkIH0pDQogICAgICAgIH0pLg0KICAgICAgICBjYXRjaCgoKSA9PiB7DQogICAgICAgICAgdGhpcy5zaG93RXJyb3JNZXNzYWdlKCJGYWlsZWQgdG8gY3JlYXRlIGNoZWNrb3V0IHNlc3Npb24sIHBsZWFzZSB0cnkgYWdhaW4uIikNCiAgICAgICAgfSkNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIC8vIGlmIHRoZSB1c2VyIGhhcyBhIHN1YnNjcmlwdGlvblByaWNlSWQsIGl0IG1lYW5zIHRoYXQgdGhlIHVzZXIgaGFzIGFscmVhZHkgc3Vic2NyaWJlZC4NCiAgICAgICAgLy8gc28gaGVyZSB3ZSBqdXN0IG5lZWQgdG8gdXBkYXRlIHRoZSBwcmljZUlkIGluIHRoZSB1c2VyIGN1cnJlbnQgc3Vic2NyaXB0aW9uLg0KICAgICAgICAvLyBwcmljZSB3aWxsIGJlIGFkanVzdGVkIG9uIGEgcHJvcmF0aW9uIGJhc2lzIGJ5IFN0cmlwZS4gaHR0cHM6Ly9zdHJpcGUuY29tL2RvY3MvYXBpL3N1YnNjcmlwdGlvbnMvdXBkYXRlDQogICAgICAgIHRoaXMudXBkYXRlU3Vic2NyaXB0aW9uKCkuDQogICAgICAgICAgICB0aGVuKCgpID0+IHsNCiAgICAgICAgICAgICAgdGhpcy4kZW1pdCgiY2xvc2VEaWFsb2ciKQ0KICAgICAgICB9KS5jYXRjaCgoKSA9PiB7DQogICAgICAgICAgdGhpcy5zaG93RXJyb3JNZXNzYWdlKCJmYWlsZWQgdG8gY2hhbmdlIHBsYW4sIHBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIiKQ0KICAgICAgICB9KQ0KICAgICAgfQ0KICAgIH0sDQogICAgc2hvd0Vycm9yTWVzc2FnZShtc2cpIHsNCiAgICAgIHRoaXMubXNnID0gbXNnDQogICAgICB0aGlzLnNuYWNrYmFyID0gdHJ1ZQ0KICAgIH0NCiAgfSwNCiAgbW91bnRlZCgpIHsNCiAgICBidXMuJG9uKCdwcm9jZWVkVG9DaGVja291dCcsIHRoaXMuY2hlY2tvdXQpDQogIH0sDQogIGNyZWF0ZWQ6IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICB0aGlzLnN0cmlwZSA9IGF3YWl0IGxvYWRTdHJpcGUodGhpcy5zdHJpcGVQdWJsaWNLZXkpDQogICAgdGhpcy5zaG93blByaWNlID0gdGhpcy5wbGFuLnByaWNlDQogIH0NCn0NCg=="},{"version":3,"sources":["CheckoutComfirm.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+CA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"CheckoutComfirm.vue","sourceRoot":"src/components","sourcesContent":["<template>\r\n  <div>\r\n    <v-flex xs12>\r\n      <v-row>\r\n        <v-col class=\"ml-5\">\r\n        <img\r\n            :src=\"plan.icon\"\r\n            width=\"100px\"\r\n        />\r\n        </v-col>\r\n        <v-col class=\"mt-5 ml-16\">\r\n          <h3>{{plan.name}}</h3>\r\n          <h5 v-if=\"shownPrice==plan.price\">${{plan.price}} / month</h5>\r\n          <div v-else>\r\n            <h5><strike>${{plan.price}} / month</strike></h5>\r\n            <h5 style=\"color:red;\">${{shownPrice}} / month</h5>\r\n          </div>\r\n        </v-col>\r\n      </v-row>\r\n    </v-flex>\r\n    <v-flex xs12>\r\n      <v-row>\r\n        <v-col class=\"ml-5\">\r\n          <v-text-field ref=\"couponRef\" @click:append=\"clearCoupon\" :append-icon=\"getIcon\" outlined dense label=\"Coupon\" v-model=\"coupon\" style=\"width:195px\"></v-text-field>\r\n        </v-col>\r\n        <v-col>\r\n          <v-btn outlined tile @click=\"applyCoupon\" :disabled=\"!coupon\">Apply</v-btn>\r\n        </v-col>\r\n      </v-row>\r\n    </v-flex>\r\n    <v-snackbar v-model=\"snackbar\" timeout=\"4000\" @click=\"snackbar=false\">\r\n      {{msg}}\r\n      <template v-slot:action=\"{ attrs }\">\r\n        <v-btn\r\n            color=\"pink\"\r\n            text\r\n            v-bind=\"attrs\"\r\n            @click=\"snackbar = false\"\r\n        >\r\n          Close\r\n        </v-btn>\r\n      </template>\r\n    </v-snackbar>\r\n  </div>\r\n</template>\r\n<script>\r\n\r\nimport {loadStripe} from '@stripe/stripe-js';\r\nimport {EventBus as bus} from \"../event_bus.js\"\r\nimport axios from \"axios\";\r\nimport {default as API_ENDPOINTS} from \"@/api\";\r\n\r\nexport default {\r\n  components: {},\r\n  props: ['plan', 'accountInfo'],\r\n  data() {\r\n    return {\r\n      stripe: {},\r\n      elements: {},\r\n      card: {},\r\n      stripePublicKey: process.env.VUE_APP_STRIPE_PUBLIC_KEY,\r\n      snackbar: false,\r\n      msg: \"\",\r\n      coupon: \"\",\r\n      isCouponValid: false,\r\n      shownPrice: \"\"\r\n    }\r\n  },\r\n  watch: {\r\n    coupon: function () {\r\n      this.isCouponValid = false\r\n      this.shownPrice = this.plan.price\r\n    },\r\n    plan: function() {\r\n      this.shownPrice = this.plan.price\r\n      this.isCouponValid = false\r\n      this.coupon = \"\"\r\n    }\r\n  },\r\n  computed: {\r\n    getIcon() {\r\n      if (!this.coupon) {\r\n        return \"mdi-ticket-percent-outline\"\r\n      } else if (this.isCouponValid) {\r\n        return \"mdi-check\"\r\n      }\r\n      return \"mdi-close\"\r\n    }\r\n  },\r\n  methods: {\r\n    clearCoupon() {\r\n      if (!this.isCouponValid && this.coupon) {\r\n        this.coupon = \"\"\r\n        this.isCouponValid = false\r\n        this.shownPrice = this.plan.price\r\n      }\r\n    },\r\n    applyCoupon() {\r\n      this.readCoupon()\r\n          .then((resp) => {\r\n            this.isCouponValid = true\r\n            this.shownPrice = resp.data.percent_off / 100 * this.plan.price\r\n          })\r\n          .catch(() => {\r\n            this.isCouponValid = false\r\n            this.coupon = \"\"\r\n            this.$refs.couponRef.focus()\r\n            this.showErrorMessage(\"Coupon is not valid\")\r\n          })\r\n    },\r\n    readCoupon() {\r\n      return axios({\r\n        url: API_ENDPOINTS.READ_COUPON(this.coupon),\r\n        method: 'GET'\r\n      })\r\n    },\r\n    updateSubscription() {\r\n      const data = {\r\n        priceId: this.plan.priceId,\r\n      }\r\n      return axios({\r\n        url: API_ENDPOINTS.UPDATE_SUBSCRIPTION(this.accountInfo.email, this.accountInfo.subscriptionId),\r\n        data: data,\r\n        method: 'PUT'\r\n      })\r\n    },\r\n    createSession() {\r\n      const data = {\r\n        coupon: this.coupon,\r\n        priceId: this.plan.priceId,\r\n        stripeCustomerId: this.accountInfo.stripeCustomerId,\r\n        plan: this.plan.name,\r\n        successUrl: process.env.VUE_APP_WEB_HOST +\"/plan?status=ok\",\r\n        cancelUrl: process.env.VUE_APP_WEB_HOST + \"/plan?status=failed\",\r\n        email: this.$store.getters.email ? this.$store.getters.email : this.accountInfo.email\r\n      }\r\n      return axios({url: API_ENDPOINTS.CHECKOUT_CREATE_SESSION, data: data, method: 'POST' })\r\n    },\r\n    checkout() {\r\n      if (this.accountInfo?.subscriptionPriceId == \"\") {\r\n        // if the user has no subscriptionPriceId, it is a brand new subscription.\r\n        this.createSession().\r\n        then((resp) => {\r\n          this.stripe.redirectToCheckout({ sessionId: resp.data.id })\r\n        }).\r\n        catch(() => {\r\n          this.showErrorMessage(\"Failed to create checkout session, please try again.\")\r\n        })\r\n      } else {\r\n        // if the user has a subscriptionPriceId, it means that the user has already subscribed.\r\n        // so here we just need to update the priceId in the user current subscription.\r\n        // price will be adjusted on a proration basis by Stripe. https://stripe.com/docs/api/subscriptions/update\r\n        this.updateSubscription().\r\n            then(() => {\r\n              this.$emit(\"closeDialog\")\r\n        }).catch(() => {\r\n          this.showErrorMessage(\"failed to change plan, please try again later\")\r\n        })\r\n      }\r\n    },\r\n    showErrorMessage(msg) {\r\n      this.msg = msg\r\n      this.snackbar = true\r\n    }\r\n  },\r\n  mounted() {\r\n    bus.$on('proceedToCheckout', this.checkout)\r\n  },\r\n  created: async function () {\r\n    this.stripe = await loadStripe(this.stripePublicKey)\r\n    this.shownPrice = this.plan.price\r\n  }\r\n}\r\n</script>\r\n\r\n\r\n<style>\r\n\r\n</style>\r\n"]}]}